---
title: "TERGM"
output: html_document
---


```{r}
# install.packages(c("network", "btergm", "tergm", "ggraph", "intergraph"))
```


```{r}
#install.packages(c("ggraph", "intergraph"))
```

```{r}
library(network)
library(tergm)
library(sna)
library(igraph)
library(ggraph)
library(intergraph)
library(ndtv)
```


```{r}
#edges_t10 <- read.csv("data/tpu_edge_list_data_2010.csv")
edges_t15 <- read.csv("data/tpu_edge_list_data_2015.csv")
edges_t20 <- read.csv("data/tpu_edge_list_data_2020.csv")
```

The `echo: false` option disables the printing of code (only output is displayed).

```{r}
#head(edges_t1)
dim(edges_t15)  
```

```{r}
nodes <- unique(c(edges_t15$from, edges_t15$to, edges_t20$from, edges_t20$to))
node_df <- data.frame(name = nodes)
```

```{r}
length(nodes)
```

```{r}
net1 <- network(edges_t15, 
                directed = TRUE, vertices = node_df, matrix.type = "edgelist")
net2 <- network(edges_t20, directed = TRUE, vertices = node_df, matrix.type = "edgelist")

indeg1 <- sna::degree(net1, cmode="indegree")
indeg2 <- sna::degree(net2, cmode="indegree")

network::set.edge.attribute(net1, "weight", edges_t15$weight)
network::set.edge.attribute(net2, "weight", edges_t20$weight)

network::set.vertex.attribute(net1, "indegree", indeg1)
network::set.vertex.attribute(net2, "indegree", indeg2)
```

```{r}
net.list <- list(net1, net2)
```


```{r}
# === 6. (ì„ íƒ) ì˜ˆì‹œ ê³µë³€ëŸ‰ ìƒì„± ===
# ë‘ ì‹œì ë§ˆë‹¤ ë™ì¼ í¬ê¸°ì˜ í–‰ë ¬ ë¦¬ìŠ¤íŠ¸ë¡œ ìƒì„±í•´ì•¼ í•¨
set.seed(123)
X1 <- matrix(runif(length(nodes)^2, 0, 1), nrow = length(nodes))
X2 <- matrix(runif(length(nodes)^2, 0, 1), nrow = length(nodes))
X.list <- list(X1, X2)

# === 7. TERGM (btergm) ëª¨ë¸ ì¶”ì • ===
set.seed(100)
model <- tergm(net.list ~ edges 
                + gwesp(0.1, fixed = TRUE) 
                #+ edgecov(X.list)
                + mutual
                + nodecov("indegree")
                + diff(attr="indegree", dir="t-h")
                , 
                estimate="CMLE", times=0:2)

# === 8. ê²°ê³¼ í™•ì¸ ===
summary(model)
```

```{r}
# nsim = ìƒì„±í•  ë„¤íŠ¸ì›Œí¬ ìˆ˜ (ê¸°ë³¸ê°’ì€ 1)
sim <- simulate(model, nsim = 1, time.slices = 5, nw.start="first")

# === 2. ê²°ê³¼ í™•ì¸ ===
# simì€ ë„¤íŠ¸ì›Œí¬ ê°ì²´ í˜•íƒœì˜ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜ë©ë‹ˆë‹¤.
class(sim)       # "list"
length(sim)      # ì˜ˆ: 1
class(sim[[1]])  # "network"

```
```{r}
str(sim, max.level = 1)
```

```{r}
plot.par = list(edge.col="darkgray",
displaylabels = T,
label.cex=.8,
label.col="blue",
vertex.cex = 1)

render.d3movie(sim)
```


```{r}
sim <- simulate(model, nsim = 1, time.slices = 3, nw.start="last")

deg <- sna::degree(net1, gmode = "digraph", cmode="indegree")
label <- ifelse(deg>=2, network.vertex.names(net1), "")
set.seed(150)
plot.network(net1,
             label=label,
             vertex.cex = sqrt(deg+1)*0.8,
             displaylabels = TRUE,
             vertex.col = "skyblue",
             vertex.border=0.3,
             edge.col = "grey60",
             label.cex = 0.6,
             edge.lwd = 0.1,
             main = "TPU Network : 2015 ~",
             displayisolates=FALSE,
             mode="fruchtermanreingold")
```



```{r}
deg <- sna::degree(net2, gmode = "digraph", cmode="indegree")
label <- ifelse(deg>=2, network.vertex.names(net2), "")
set.seed(513)
plot.network(net2,
             label=label,
             vertex.cex = sqrt(deg+1)*0.8,
             displaylabels = TRUE,
             vertex.col = "skyblue",
             vertex.border=0.3,
             edge.col = "grey60",
             label.cex = 0.6,
             edge.lwd = 0.1,
             main = "TPU Network : 2020 ~",
             displayisolates=FALSE,
             mode="fruchtermanreingold")
```



```{r}
# Simulated results
simp1 <- network.extract(sim, at=1)
deg <- sna::degree(simp1, gmode = "digraph", cmode="indegree")
label <- ifelse(deg>=2, network.vertex.names(simp1), "")
set.seed(52113)
plot.network(simp1,
             label=label,
             vertex.cex = sqrt(deg+1)*0.8,
             displaylabels = TRUE,
             vertex.col = "skyblue",
             vertex.border=0.3,
             edge.col = "grey60",
             label.cex = 0.6,
             edge.lwd = 0.3,
             main = "TPU Network : 2025 ~",
             displayisolates=FALSE,
             mode="fruchtermanreingold"
             )
```

```{r}
# Simulated results
simp2 <- network.extract(sim, at=2)
deg <- sna::degree(simp2, gmode = "digraph", cmode="indegree")
label <- ifelse(deg>=3, network.vertex.names(simp2), "")
set.seed(5156)
plot.network(simp2,
             label=label,
             vertex.cex = sqrt(deg+1)*0.8,
             displaylabels = TRUE,
             vertex.col = "skyblue",
             vertex.border=0.3,
             edge.col = "grey60",
              label.cex = 0.6,
              edge.lwd = 0.3,
             main = "TPU Network : 2030 ~",
             displayisolates=FALSE,
             mode="fruchtermanreingold")
```


```{r}
# Simulated results
simp3 <- network.extract(sim, at=3)
deg <- sna::degree(simp3, gmode = "digraph", cmode="indegree")
label <- ifelse(deg>=2, network.vertex.names(simp3), "")
set.seed(515)
plot.network(simp3,
             label=label,
             vertex.cex = sqrt(deg+1)*0.8,
             displaylabels = TRUE,
             vertex.col = "skyblue",
             vertex.border=0.3,
             edge.col = "grey60",
             label.cex = 0.6,
             edge.lwd = 0.1,
             main = "TPU Network : 2035 ~",
             displayisolates=FALSE,
             mode="fruchtermanreingold")
```


```{r}
library(dplyr)
library(sna)
library(network)

find_new_edges_tergm <- function(net_pred, net_list) {
  if (length(net_list) < 2) stop("âŒ net_listì—ëŠ” ìµœì†Œ 2ê°œì˜ ë„¤íŠ¸ì›Œí¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
  
  # --- ê¸°ì¤€ ë…¸ë“œì…‹ ì¶”ì¶œ ---
  base_nodes <- network.vertex.names(net_list[[1]])
  
  # --- ì—£ì§€ë¦¬ìŠ¤íŠ¸ë¥¼ node name ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ ---
  get_edges_named <- function(net, base_nodes) {
    el <- as.data.frame(as.edgelist.sna(net))[, 1:2]
    names(el) <- c("from_id", "to_id")
    el <- el %>%
      mutate(
        from = base_nodes[from_id],
        to   = base_nodes[to_id]
      ) %>%
      select(from, to)
    return(el)
  }
  
  # --- ê° ë„¤íŠ¸ì›Œí¬ì—ì„œ ì—£ì§€ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ ---
  edges_prev1 <- get_edges_named(net_list[[1]], base_nodes)
  edges_prev2 <- get_edges_named(net_list[[2]], base_nodes)
  edges_pred  <- get_edges_named(net_pred,     base_nodes)
  
  # --- ê³¼ê±° ì—£ì§€ í†µí•© ---
  edges_prev_all <- distinct(bind_rows(edges_prev1, edges_prev2))
  
  # --- ìƒˆë¡­ê²Œ ë“±ì¥í•œ ì—£ì§€ ì¶”ì¶œ ---
  edges_new <- anti_join(edges_pred, edges_prev_all, by = c("from", "to"))
  
  cat("âœ… ìƒˆë¡œ ë“±ì¥í•œ ì—£ì§€ ìˆ˜:", nrow(edges_new), "\n")
  return(edges_new)
}




```



```{r}
# ---- indegree ê¸°ë°˜ ë…¸ë“œ í¬ê¸° / ë¼ë²¨ ì„¤ì • ----
edges_new <- find_new_edges_tergm(simp1, list(net1, net2))
deg <- sna::degree(simp1, gmode = "digraph", cmode = "indegree")
label <- ifelse(deg >= 2, network.vertex.names(simp1), "")

# ---- ë„¤íŠ¸ì›Œí¬ ì‹œê°í™” ----
set.seed(52113)
plot.network(
  simp1,
  label = label,
  vertex.cex = sqrt(deg + 1) * 0.8,   # indegreeì— ë”°ë¥¸ ë…¸ë“œ í¬ê¸°
  displaylabels = TRUE,
  vertex.col = "skyblue",
  vertex.border = 0.3,
  edge.col = ifelse(
    paste0(as.edgelist.sna(simp1)[, 1], "-", as.edgelist.sna(simp1)[, 2]) %in%
      paste0(match(edges_new$from, network.vertex.names(simp1)), "-", 
             match(edges_new$to, network.vertex.names(simp1))),
    "red", "grey60"                   # ğŸ”´ ìƒˆ ì—£ì§€ëŠ” ë¹¨ê°„ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” íšŒìƒ‰
  ),
  label.cex = 0.6,
  edge.lwd = 0.3,
  main = "TPU Network : 2030 ~ (New Edges Highlighted)",
  displayisolates = FALSE,            # ê³ ë¦½ ë…¸ë“œ ì œê±°
  mode = "fruchtermanreingold"        # ë ˆì´ì•„ì›ƒ
)


```



```{r}
# ---- indegree ê¸°ë°˜ ë…¸ë“œ í¬ê¸° / ë¼ë²¨ ì„¤ì • ----
edges_new <- find_new_edges_tergm(simp2, list(net1, net2))
deg <- sna::degree(simp2, gmode = "digraph", cmode = "indegree")
label <- ifelse(deg >= 3, network.vertex.names(simp2), "")

# ---- ë„¤íŠ¸ì›Œí¬ ì‹œê°í™” ----
set.seed(5156)
plot.network(
  simp2,
  label = label,
  vertex.cex = sqrt(deg + 1) * 0.8,   # indegreeì— ë”°ë¥¸ ë…¸ë“œ í¬ê¸°
  displaylabels = TRUE,
  vertex.col = "skyblue",
  vertex.border = 0.3,
  edge.col = ifelse(
    paste0(as.edgelist.sna(simp2)[, 1], "-", as.edgelist.sna(simp2)[, 2]) %in%
      paste0(match(edges_new$from, network.vertex.names(simp2)), "-", 
             match(edges_new$to, network.vertex.names(simp2))),
    "red", "grey60"                   # ğŸ”´ ìƒˆ ì—£ì§€ëŠ” ë¹¨ê°„ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” íšŒìƒ‰
  ),
  label.cex = 0.6,
  edge.lwd = 0.3,
  main = "TPU Network : 2040 ~ (New Edges Highlighted)",
  displayisolates = FALSE,            # ê³ ë¦½ ë…¸ë“œ ì œê±°
  mode = "fruchtermanreingold"        # ë ˆì´ì•„ì›ƒ
)


```

```{r}
# ---- indegree ê¸°ë°˜ ë…¸ë“œ í¬ê¸° / ë¼ë²¨ ì„¤ì • ----
edges_new <- find_new_edges_tergm(simp3, list(net1, net2))
deg <- sna::degree(simp3, gmode = "digraph", cmode = "indegree")
label <- ifelse(deg >= 3, network.vertex.names(simp3), "")

# ---- ë„¤íŠ¸ì›Œí¬ ì‹œê°í™” ----
set.seed(515)
plot.network(
  simp3,
  label = label,
  vertex.cex = sqrt(deg + 1) * 0.8,   # indegreeì— ë”°ë¥¸ ë…¸ë“œ í¬ê¸°
  displaylabels = TRUE,
  vertex.col = "skyblue",
  vertex.border = 0.3,
  edge.col = ifelse(
    paste0(as.edgelist.sna(simp3)[, 1], "-", as.edgelist.sna(simp3)[, 2]) %in%
      paste0(match(edges_new$from, network.vertex.names(simp3)), "-", 
             match(edges_new$to, network.vertex.names(simp3))),
    "red", "grey60"                   # ğŸ”´ ìƒˆ ì—£ì§€ëŠ” ë¹¨ê°„ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” íšŒìƒ‰
  ),
  label.cex = 0.6,
  edge.lwd = 0.3,
  main = "TPU Network : 2050 ~ (New Edges Highlighted)",
  displayisolates = FALSE,            # ê³ ë¦½ ë…¸ë“œ ì œê±°
  mode = "fruchtermanreingold"        # ë ˆì´ì•„ì›ƒ
)


```
